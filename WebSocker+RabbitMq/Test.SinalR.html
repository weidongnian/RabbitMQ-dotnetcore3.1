<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试SinalR+websocket连接</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.7/signalr.min.js"></script>
    <script>
        var start = function () {
            var connection = null;
            var _api = '/api/stroke/messaging';
            _api = 'http://192.168.1.162/ws/AggregateService/push';
            //_api='http://192.168.1.162:59001/push';
            //_api="http://localhost:5005/push";

            var init = () => {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl(_api, {
                        skipNegotiation: true,
                        transport: signalR.HttpTransportType.WebSockets
                    })
                    .configureLogging(signalR.LogLevel.Information)
                    .build();

                return connection;
            };

            init();

            //Receive,ReceiveMsg
            connection.on("ReceiveMsg", d => {
                console.log('==收到websocket啦');
                console.log(d);
                debugger
                if (d && d.data != undefined)
                    switch (d.data) {
                        case 1:
                        case 2:
                        case 3:
                        case 4:
                            this.popmsg = d.msg;
                            this.newInfo = true;
                            this.patientId = d.exten.patientId;
                            break;
                        default:
                            d.msg && this.openMsg(d.msg);
                            break;
                    }
            });

            let _rmsg = () => {
                var _m = "当前网络已经中断,正在重连中.....";
                console.error(_m);
            };

            async function start() {
                try {
                    await connection.start();
                    console.log("signalR connected");
                } catch (err) {
                    console.log("signalR connected error");
                    console.log("满足");
                    _rmsg();
                    setTimeout(() => start(), 5000);
                }
            }

            start();

            connection.onclose(async () => {
                console.log("signalR onclose...");
                _rmsg();
                await start();
            });
        }
    </script>
</head>

<body>
    <div>

    </div>
</body>

</html>